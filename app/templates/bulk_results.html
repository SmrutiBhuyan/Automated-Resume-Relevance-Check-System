{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Bulk Evaluation Results</h2>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
      </a>
    </div>

    <!-- Job Description Info -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Job Description</h5>
      </div>
      <div class="card-body">
        <h6>{{ job_description.title }}</h6>
        <p><strong>Company:</strong> {{ job_description.company or 'N/A' }}</p>
        <p><strong>Location:</strong> {{ job_description.location or 'N/A' }}</p>
        <p><strong>Must Have Skills:</strong> {{ (job_description.must_have_skills or [])|join(', ') }}</p>
        <p><strong>Qualifications:</strong> {{ (job_description.qualifications or [])|join(', ') }}</p>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Filters</h5>
      </div>
      <div class="card-body">
        <form method="GET" class="row g-3">
          <div class="col-md-3">
            <label for="session" class="form-label">Upload Session</label>
            <select class="form-select" id="session" name="session">
              <option value="">All Sessions</option>
              {% for session in all_sessions %}
              <option value="{{ session.upload_session_id }}" 
                      {% if session.upload_session_id == current_session %}selected{% endif %}>
                {{ session.upload_session_id[:8] if session.upload_session_id else 'Individual' }} 
                ({{ session.count }} resumes, {{ session.last_upload.strftime('%Y-%m-%d %H:%M') }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label for="date" class="form-label">Date Filter</label>
            <select class="form-select" id="date" name="date">
              <option value="">All Time</option>
              <option value="today" {% if current_date == 'today' %}selected{% endif %}>Today</option>
              <option value="week" {% if current_date == 'week' %}selected{% endif %}>Last 7 Days</option>
              <option value="month" {% if current_date == 'month' %}selected{% endif %}>Last 30 Days</option>
            </select>
          </div>
          <div class="col-md-3">
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" id="bulk_only" name="bulk_only" 
                     {% if show_only_bulk %}checked{% endif %}>
              <label class="form-check-label" for="bulk_only">
                Show only bulk uploads
              </label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="d-grid">
              <button type="submit" class="btn btn-primary mt-4">
                <i class="fas fa-filter me-1"></i>Apply Filters
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-primary">{{ total_evaluations }}</h3>
            <p class="card-text">Total Resumes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-success">{{ high_suitability }}</h3>
            <p class="card-text">High Suitability</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-warning">{{ medium_suitability }}</h3>
            <p class="card-text">Medium Suitability</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-danger">{{ low_suitability }}</h3>
            <p class="card-text">Low Suitability</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Average Score -->
    <div class="card mb-4">
      <div class="card-body text-center">
        <h5 class="card-title">Average Relevance Score</h5>
        <div class="display-4 
          {% if avg_score >= 80 %}score-high
          {% elif avg_score >= 60 %}score-medium
          {% else %}score-low
          {% endif %}">
          {{ "%.1f"|format(avg_score) }}%
        </div>
      </div>
    </div>

    <!-- Results Table -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Evaluation Results</h5>
      </div>
      <div class="card-body">
        {% if evaluations %}
          {% if sessions|length > 1 %}
            <!-- Grouped by Session View -->
            {% for session_id, session_data in sessions.items() %}
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-layer-group me-2"></i>{{ session_data.session_name }}
                <span class="badge bg-secondary ms-2">{{ session_data.count }} resumes</span>
                <small class="text-muted ms-2">{{ session_data.upload_date.strftime('%Y-%m-%d %H:%M') }}</small>
              </h6>
              
              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Rank</th>
                      <th>Resume</th>
                      <th>Final Score</th>
                      <th>Verdict</th>
                      <th>Keyword Score</th>
                      <th>Semantic Score</th>
                      <th>Missing Skills</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for evaluation in session_data.evaluations %}
                    <tr>
                      <td>
                        <span class="badge bg-primary">{{ loop.index }}</span>
                      </td>
                      <td>
                        <div>
                          <strong>{{ evaluation.resume.original_filename }}</strong>
                          {% if evaluation.resume.student_name and evaluation.resume.student_name != "Bulk Upload - " + evaluation.resume.original_filename %}
                          <br><small class="text-muted">{{ evaluation.resume.student_name }}</small>
                          {% endif %}
                        </div>
                      </td>
                      <td>
                        <span class="fw-bold
                          {% if evaluation.final_score >= 80 %}text-success
                          {% elif evaluation.final_score >= 60 %}text-warning
                          {% else %}text-danger
                          {% endif %}">
                          {{ "%.1f"|format(evaluation.final_score or 0) }}%
                        </span>
                      </td>
                      <td>
                        <span class="badge 
                          {% if evaluation.verdict == 'High' %}bg-success
                          {% elif evaluation.verdict == 'Medium' %}bg-warning
                          {% else %}bg-danger
                          {% endif %}">
                          {{ evaluation.verdict }}
                        </span>
                      </td>
                      <td>{{ "%.1f"|format(evaluation.keyword_score or 0) }}%</td>
                      <td>{{ "%.1f"|format(evaluation.semantic_score or 0) }}%</td>
                      <td>
                        {% if evaluation.missing_skills %}
                          <span class="text-danger">{{ evaluation.missing_skills|length }} missing</span>
                        {% else %}
                          <span class="text-success">None</span>
                        {% endif %}
                      </td>
                      <td>
                        <a href="{{ url_for('main.results', evaluation_id=evaluation.id) }}" 
                           class="btn btn-sm btn-outline-primary">
                          <i class="fas fa-eye"></i> View Details
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <!-- Single Table View -->
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Resume</th>
                    <th>Final Score</th>
                    <th>Verdict</th>
                    <th>Keyword Score</th>
                    <th>Semantic Score</th>
                    <th>Missing Skills</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for evaluation in evaluations %}
                  <tr>
                    <td>
                      <span class="badge bg-primary">{{ loop.index }}</span>
                    </td>
                    <td>
                      <div>
                        <strong>{{ evaluation.resume.original_filename }}</strong>
                        {% if evaluation.resume.student_name and evaluation.resume.student_name != "Bulk Upload - " + evaluation.resume.original_filename %}
                        <br><small class="text-muted">{{ evaluation.resume.student_name }}</small>
                        {% endif %}
                      </div>
                    </td>
                    <td>
                      <span class="fw-bold
                        {% if evaluation.final_score >= 80 %}text-success
                        {% elif evaluation.final_score >= 60 %}text-warning
                        {% else %}text-danger
                        {% endif %}">
                        {{ "%.1f"|format(evaluation.final_score or 0) }}%
                      </span>
                    </td>
                    <td>
                      <span class="badge 
                        {% if evaluation.verdict == 'High' %}bg-success
                        {% elif evaluation.verdict == 'Medium' %}bg-warning
                        {% else %}bg-danger
                        {% endif %}">
                        {{ evaluation.verdict }}
                      </span>
                    </td>
                    <td>{{ "%.1f"|format(evaluation.keyword_score or 0) }}%</td>
                    <td>{{ "%.1f"|format(evaluation.semantic_score or 0) }}%</td>
                    <td>
                      {% if evaluation.missing_skills %}
                        <span class="text-danger">{{ evaluation.missing_skills|length }} missing</span>
                      {% else %}
                        <span class="text-success">None</span>
                      {% endif %}
                    </td>
                    <td>
                      <a href="{{ url_for('main.results', evaluation_id=evaluation.id) }}" 
                         class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> View Details
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No evaluations found</h5>
          <p class="text-muted">Upload some resumes to see evaluation results here.</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Export Options -->
    {% if evaluations %}
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Export Options</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <button class="btn btn-success" onclick="exportToCSV()">
              <i class="fas fa-file-csv me-2"></i>Export to CSV
            </button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-primary" onclick="exportToPDF()">
              <i class="fas fa-file-pdf me-2"></i>Export to PDF
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
function exportToCSV() {
    // Create CSV content
    let csvContent = "Rank,Resume,Final Score,Verdict,Keyword Score,Semantic Score,Missing Skills Count\n";
    
    {% for evaluation in evaluations %}
    csvContent += "{{ loop.index }},{{ evaluation.resume.original_filename }},{{ "%.1f"|format(evaluation.final_score or 0) }}%,{{ evaluation.verdict }},{{ "%.1f"|format(evaluation.keyword_score or 0) }}%,{{ "%.1f"|format(evaluation.semantic_score or 0) }}%,{{ evaluation.missing_skills|length }}\n";
    {% endfor %}
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bulk_evaluation_results.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function exportToPDF() {
    // Simple PDF export using window.print
    window.print();
}
</script>
{% endblock %}
